# pdf-import Specification

## Purpose
TBD - created by archiving change update-pdf-import-statements. Update Purpose after archive.
## Requirements
### Requirement: 明細タイプ選択と銀行反映
PDF抽出UIは、抽出前に「総合振込明細」または「カード利用明細」を必ず選択できなければならない（SHALL）。選択したタイプに応じてプロンプトを切り替え、利用者が指定した銀行（支払口座/引落口座）を出力CSVの「銀行」カラムへ反映しなければならない（SHALL）。

#### Scenario: 総合振込明細を選択して抽出
- **GIVEN** ユーザーが抽出タイプに「総合振込明細」を選び、銀行に「みずほ」を指定している
- **WHEN** pageモードまたはrangeモードで抽出を実行する
- **THEN** サーバーは総合振込専用のプロンプトでGeminiへ送信する
- **AND** 返却CSVの各行の「銀行」カラムには「みずほ」がセットされる

#### Scenario: カード利用明細を選択して抽出
- **GIVEN** ユーザーが抽出タイプに「カード利用明細」を選び、銀行に「SBI」を指定している
- **WHEN** pageモードまたはrangeモードで抽出を実行する
- **THEN** サーバーはカード明細専用のプロンプトでGeminiへ送信する
- **AND** 返却CSVの各行の「銀行」カラムには「SBI」がセットされる

### Requirement: 総合振込明細のCSVマッピング
総合振込明細タイプの出力は bank-csv-grid の取引グリッド列（`取引日,内容,入金,出金,残高,メモ,銀行`）に直接挿入できる形で返さなければならない（SHALL）。内容は「受取人名・銀行・支店・科目・口座番号」を結合した文字列を使用しなければならない（SHALL）。入金は常に0とし（SHALL）、出金は振込金額/支払金額欄の数値から通貨記号・円・カンマ・ハイフンを除いた純数値を採用し（SHALL）、同一行に複数数値がある場合は上段（最初に出現するもの）を用いなければならない（SHALL）。残高は空欄とし（SHALL）、メモは「総合振込明細」と固定しなければならない（SHALL）。

#### Scenario: 総合振込の金額抽出と内容結合
- **GIVEN** 抽出タイプが総合振込明細で、PDFの1行に「受取人:ABC商事 銀行:東京 支店:本店 科目:当座 口座:123456」「振込金額: ¥12,300」「支払金額: ¥10,000」が縦に並んでいる
- **WHEN** 抽出を実行する
- **THEN** 返却CSVの該当行は「内容=ABC商事 東京 本店 当座 123456」「入金=0」「出金=12300」（最初の金額を優先）「残高=空」「メモ=総合振込明細」を含む

### Requirement: カード利用明細のCSVマッピング
カード利用明細タイプの出力は bank-csv-grid の取引グリッド列に直接挿入できる形で返さなければならない（SHALL）。内容は「ご利用店名・ご利用先・摘要」を結合した文字列を使用しなければならない（SHALL）。入金は常に0とし（SHALL）、出金は「支払金額」欄の数値から通貨記号・円・カンマ・ハイフンを除いた純数値を採用し（SHALL）。残高は空欄とし（SHALL）、メモは「カード利用明細」と固定しなければならない（SHALL）。

#### Scenario: カード支払金額の抽出
- **GIVEN** 抽出タイプがカード利用明細で、PDFの1行に「ご利用店名:ABC STORE」「摘要:オンライン購入」「支払金額: ¥8,000」「利用金額: ¥8,000」が記載されている
- **WHEN** 抽出を実行する
- **THEN** 返却CSVの該当行は「内容=ABC STORE オンライン購入」「入金=0」「出金=8000」（支払金額を使用）「残高=空」「メモ=カード利用明細」を含む

### Requirement: 親明細メタの引き継ぎとID連番付与
pdf-importは親トランザクションの `id`・`bank`・`date` を受け取り表示しなければならない（SHALL）。抽出結果の各行には親の `bank` と `date` を自動でセットし（SHALL）、行IDは親IDに `-001` からの3桁連番を付与した文字列で生成しなければならない（SHALL）。

#### Scenario: 親ID付与と日付/銀行の自動セット
- **GIVEN** 親トランザクションIDが `UUID`、銀行が `sbi`、取引日が `2024/12/01` の行から遷移している
- **WHEN** PDF抽出を実行する
- **THEN** 生成される各行の `id` は `UUID-001`, `UUID-002`, ... のように連番が付与される
- **AND** 各行の `bank` は `sbi`、`date` は `2024/12/01` が自動でセットされる

### Requirement: 紐付け実行による子明細送信
pdf-importは「紐付け実行」操作で、親IDと生成した行（id, bank, date, description, credit, debit, balance, memo を含む）を bank-csv-grid の受入APIへ送信しなければならない（SHALL）。送信は抽出モード（page/range）に依存せず同一ペイロード形式を用い（SHALL）、エラー時はユーザーへ明示的に通知しなければならない（SHALL）。

#### Scenario: 紐付け実行の送信と通知
- **GIVEN** 抽出結果に2行が存在し、親IDが `UUID` である
- **WHEN** ユーザーが「紐付け実行」を押す
- **THEN** pdf-importは `parentId=UUID` と2行の明細をAPIへPOSTする
- **AND** APIが失敗した場合、エラーメッセージがUIに表示される

