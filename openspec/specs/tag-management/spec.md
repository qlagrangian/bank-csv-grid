# tag-management Specification

## Purpose
TBD - created by archiving change improve-tag-ui-ux. Update Purpose after archive.
## Requirements
### Requirement: タグレコードのキーバインド操作
タグツリーにおいて、タグレコードのキーボード操作は以下の動作をサポートしなければならない（SHALL）:
- タグレコード選択時にENTERキーを押すと、子タグ名入力フィールドに自動的にフォーカスが移動する
- タグレコードの名称変更は、ダブルクリック時のみトリガーされる（ENTERキーではトリガーされない）

#### Scenario: ENTERキーで子タグ入力にフォーカス
- **GIVEN** タグツリーで親タグレコードを選択している
- **WHEN** ENTERキーを押す
- **THEN** 右側の「子タグ名」入力フィールドに自動的にフォーカスが移動する
- **AND** カーソルが入力フィールド内に表示され、即座に文字入力が可能な状態になる

#### Scenario: ダブルクリックで名称変更モードに入る
- **GIVEN** タグツリーでタグレコードを表示している
- **WHEN** タグレコードをダブルクリックする
- **THEN** 名称変更モードに入り、タグ名がインライン編集可能になる

#### Scenario: ENTERキーでは名称変更モードに入らない
- **GIVEN** タグツリーでタグレコードを選択している
- **WHEN** ENTERキーを押す
- **THEN** 名称変更モードには入らない
- **AND** 子タグ名入力フィールドにフォーカスが移動する

### Requirement: 子タグ追加フローのキーボード操作
子タグ追加フローは、キーボードのみで完結できなければならない（SHALL）:
- 子タグ名入力フィールドでENTERを押すと、「追加」ボタンにフォーカスが移動する
- 「追加」ボタンにフォーカスがある状態でENTERを押すと、ボタンが押下され子タグが追加される

#### Scenario: 入力フィールドからボタンへのフォーカス移動
- **GIVEN** 子タグ名入力フィールドにフォーカスがあり、タグ名を入力済み
- **WHEN** ENTERキーを押す
- **THEN** 子タグ名入力フィールドからフォーカスが外れる
- **AND** 「追加」ボタンにフォーカスが移動する
- **AND** ボタンがフォーカス状態を示すビジュアル（アウトライン等）を表示する

#### Scenario: 追加ボタンでENTERキーによる子タグ追加
- **GIVEN** 「追加」ボタンにフォーカスがある
- **AND** 子タグ名入力フィールドに有効なタグ名が入力されている
- **WHEN** ENTERキーを押す
- **THEN** 「追加」ボタンがクリックされたのと同じ動作が実行される
- **AND** 子タグがタグツリーに追加される
- **AND** 入力フィールドがクリアされる

### Requirement: タグツリーの階層インデント表示
タグツリーは、親子階層を視覚的に表現するため、階層レベルに応じたインデントを適用しなければならない（SHALL）。

#### Scenario: 親タグと子タグのインデント差
- **GIVEN** 親タグ「収入」と子タグ「給与」が存在する
- **WHEN** タグツリーを表示する
- **THEN** 子タグ「給与」は親タグ「収入」よりも右側にインデントされて表示される

#### Scenario: 多階層のインデント表示
- **GIVEN** 親タグ「収入」、子タグ「給与」、孫タグ「基本給」が存在する
- **WHEN** タグツリーを表示する
- **THEN** 「収入」は左端に表示される
- **AND** 「給与」は「収入」より1段階右にインデントされる
- **AND** 「基本給」は「給与」より更に1段階右にインデントされる

### Requirement: 矢印キーによる展開・折りたたみ操作
タグツリーにおいて、矢印キーを使用した子科目の展開・折りたたみをサポートしなければならない（SHALL）。

#### Scenario: 右矢印キーで子科目を展開
- **GIVEN** 子タグを持つ親タグレコードを選択している
- **AND** 子科目が折りたたまれている（非表示）
- **WHEN** 右矢印キーを押す
- **THEN** 選択中の親タグの子科目が展開され、表示される

#### Scenario: 左矢印キーで子科目を折りたたむ
- **GIVEN** 子タグを持つ親タグレコードを選択している
- **AND** 子科目が展開されている（表示）
- **WHEN** 左矢印キーを押す
- **THEN** 選択中の親タグの子科目が折りたたまれ、非表示になる

#### Scenario: 子タグがない場合の矢印キー操作
- **GIVEN** 子タグを持たないタグレコードを選択している
- **WHEN** 右矢印キーまたは左矢印キーを押す
- **THEN** 何も動作しない（エラーも表示しない）

### Requirement: タグツリーUIの視覚的改善
タグツリーは、財務系アプリとして最低限の品質を満たすビジュアルデザインでなければならない（SHALL）:
- 展開/折りたたみボタン（＋/ー）は、ボタンであることが明確に分かるデザインとする
- 親子階層が視覚的に把握しやすい表形式または類似のレイアウトを採用する

#### Scenario: 展開・折りたたみボタンの視覚的明確性
- **GIVEN** 子タグを持つ親タグレコードが表示されている
- **WHEN** タグツリーを表示する
- **THEN** 展開/折りたたみボタン（＋/ー）がボタンとして認識できるビジュアル（境界線、背景色、ホバー効果など）を持つ

#### Scenario: 階層構造の視覚的把握
- **GIVEN** 複数階層のタグが存在する
- **WHEN** タグツリーを表示する
- **THEN** インデント、罫線、または類似の視覚的手がかりにより、親子関係が一目で把握できる
- **AND** 財務系アプリケーションとして違和感のないシンプルなデザインである

### Requirement: タグCSVインポート（プレビューと適用）
システムはタグ階層をCSVでインポートできなければならない（SHALL）。CSVはLevel列で階層を表現し（左から親→子）、ヘッダー必須・UTF-8であること（SHALL）。インポート前にプレビュー（dry-run）を提供し、重複・循環・欠損・深さ超過などのエラーをユーザーに通知しなければならない（SHALL）。適用はmerge/replaceモードを選択でき、結果サマリ（作成/更新/スキップ/警告/エラー件数）を返さなければならない（SHALL）。

#### Scenario: CSVインポートのプレビューと適用
- **GIVEN** ヘッダー `Level1,Level2,Level3,Order,Active` を持つUTF-8 CSVファイルが用意されている
- **WHEN** ユーザーがインポート画面でファイルを選択し、プレビュー（dry-run）を実行する
- **THEN** システムは階層を解釈し、エラーがあれば行番号付きで表示する
- **AND** ユーザーがmergeまたはreplaceを選択して適用すると、結果サマリが表示される

### Requirement: タグCSVエクスポート
システムは現在のタグ階層をインポートと同一フォーマットのCSVでダウンロードできなければならない（SHALL）。Level列は最大深さ分を出力し、OrderとActiveも列として含めなければならない（SHALL）。

#### Scenario: 現在のタグ階層をCSVとして取得
- **GIVEN** タグツリーに複数階層のタグが登録されている
- **WHEN** ユーザーがエクスポート操作を行う
- **THEN** システムはUTF-8のCSVを返し、各タグが適切なLevel列に出力され、OrderとActiveの値も含まれる

### Requirement: CSV Import/Exportセクションの視覚的明確性

The tag master editor MUST provide visually clear section boundaries and hierarchy for CSV import/export functionality. タグマスタエディタは、CSVインポート/エクスポート機能において、視覚的に明確なセクション境界と階層構造を提供しなければならない。

#### Scenario: Import/Exportセクションの視覚的区分

**Given** タグマスタエディタのCSVインポート/エクスポートアコーディオンを開く
**When** セクション内容を表示する
**Then** エクスポートセクションとインポートセクションが視覚的に明確に区分されている
**And** 見出し（`<h4>`）がフォント太字・適切なサイズで表示される
**And** 両セクションの間に水平罫線（`<hr>`）が表示される

#### Scenario: インポートフローの階層表示

**Given** CSVインポートセクションを表示する
**When** ステップ（1. ファイル選択、2. モード選択、3. 実行）を確認する
**Then** 各ステップに`<Label>`による見出しが付与され、操作順序が明確である
**And** 各ステップがグループ化され、余白・境界で視覚的に区分されている
**And** ファイル入力フィールドがスタイル付き（hover効果、適切なpadding）で表示される

#### Scenario: 財務アプリとしてのデザイン品質

**Given** タグマスタエディタ全体を表示する
**When** UIコンポーネントを確認する
**Then** カード、ボタン、入力フィールドが統一されたデザインシステムに従っている
**And** 文字だけでなく視覚的要素（境界線、余白、階層）でセクションが識別可能である
**And** 財務系アプリケーションとして違和感のない品質を満たしている

