# Proposal: Add Loan Management and Opening Balance Features

## Summary

融資管理機能と期首残高の自動計算機能を追加し、集計パネルを拡張して借入残高推移と累積営業ネットキャッシュを表示できるようにする。また、取引管理と融資管理を切り替えるサイドメニューUIを実装する。

## Motivation

**現状の課題:**
1. 融資データを管理する仕組みがなく、借入残高を把握できない
2. 各月の期首残高を手動で計算する必要があり、資金繰り管理が非効率
3. 営業活動によるキャッシュフロー（借入を除く）を可視化できない
4. 複数の機能ページへのナビゲーションが提供されていない

**解決する問題:**
- 融資情報（銀行、バッチ名、金額、発生年月）を登録・管理できる
- 期首残高を自動計算し、集計パネルに表示する
- 借入残高推移を月次で可視化する
- 累積営業ネットキャッシュ（月合計 - 借入合計）を計算・表示する
- サイドメニューで取引管理ページと融資管理ページを切り替える

## Scope

### In Scope
- **データモデル**: Loanモデルの追加（銀行、融資バッチ名、金額、発生年月、タグID）
- **API**: 融資のCRUD操作（GET/POST/PATCH/DELETE /api/loans）
- **タグ自動生成**: 融資登録時に銀行タグと融資バッチタグを自動作成
- **期首残高計算**: トランザクションデータから各月・各銀行の期首残高を計算
- **report API拡張**: `openingBalances`と`loans`フィールドをレスポンスに追加
- **UI**: 融資登録フォーム、融資額パネル（react-data-grid）、サイドメニュー
- **集計パネル拡張**: 期首残高行、借入残高行群、累積営業ネットキャッシュ行を追加

### Out of Scope
- 返済処理の自動化（タグ付けで手動管理）
- 期首残高の手動入力機能（将来対応）
- 返済スケジュールの管理
- レポートのPDF出力
- レスポンシブ対応（デスクトップ専用）

## User Impact

**想定ユーザー**: 財務担当者、経理担当者

**利用シーン:**
1. 新規融資を受けたときに融資情報を登録する
2. 月次レポートで期首残高を確認し、資金繰り計画を立てる
3. 集計パネルで借入残高推移を確認し、返済計画を把握する
4. 累積営業ネットキャッシュを見て、借入を除いた営業活動の成果を評価する

**期待される効果:**
- 融資残高の可視化により、資金調達状況を把握できる
- 期首残高の自動計算により、手動計算の手間が削減される
- 営業キャッシュフローの明確化により、経営判断の精度が向上する

## Dependencies

### Technical Dependencies
- PostgreSQL（Prismaでマイグレーション）
- react-data-grid（融資額パネルと集計パネル）
- 既存のTag/TagAssignmentモデル（タグ自動生成で使用）
- 既存のTransactionモデル（期首残高計算で使用）

### Data Dependencies
- Transactionデータ: `balance`フィールドが正確に記録されていることが前提
- CSVデータ: 月初から月末まで完全な取引レコードを含むことが前提

### Spec Dependencies
- **tag-management**: タグ自動生成ロジックで参照
- **transaction-tagging**: 返済取引とのタグ付け連携

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Transactionデータの`balance`が不正確 | 期首残高計算が誤る | CSVインポート時のバリデーション強化、手動修正機能（将来対応） |
| 融資バッチ名の重複 | タグ生成エラー | Unique制約でエラーを返し、ユーザーに別名を促す |
| report APIのパフォーマンス低下 | 集計パネルの表示遅延 | 期首残高計算をクエリ最適化（インデックス追加、生SQL使用） |
| タグ削除時の副作用 | 融資削除でタグが残る/消える | TagAssignmentの有無を確認し、条件付きで削除 |

## Success Criteria

**機能要件:**
- [ ] 融資を登録すると、自動でタグが生成される
- [ ] 集計パネルの最上段に期首残高行が表示される
- [ ] 集計パネルの最下段に借入残高行群と累積ネットキャッシュ行が表示される
- [ ] サイドメニューで取引管理と融資管理を切り替えられる

**非機能要件:**
- [ ] report APIのレスポンスタイムが1秒以内
- [ ] 期首残高計算が100件のTransactionに対して500ms以内
- [ ] グリッド描画が50行×12ヶ月で1秒以内

**検証方法:**
- 単体テスト: API endpoint（loans CRUD、report拡張）
- 統合テスト: 融資登録→タグ生成→集計パネル表示のフロー
- パフォーマンステスト: Chrome DevTools Networkタブでレスポンスタイム計測

## Implementation Reference

**詳細仕様の参照先**: `docs/wd_cc/`ディレクトリ
- `01_requirements.md`: 機能要件の詳細
- `02_architecture.md`: アーキテクチャ設計
- `03_api_spec.md`: API仕様
- `04_ui_design.md`: UI設計
- `05_implementation_guide.md`: 実装手順（4 Phase構成）

**重要**: これらのドキュメントの内容を厳守すること。特に以下の点に注意:
- Loanモデルのスキーマ定義（`@@unique([bank, batchName])`制約含む）
- タグ自動生成ロジック（銀行タグ→融資バッチタグの階層）
- 期首残高計算ロジック（LOGIC-01, LOGIC-02, LOGIC-03）
- report APIレスポンスの拡張（`openingBalances`, `loans`フィールド）
- UI行構成の順序（期首残高→タグ階層→月合計→借入行群→累積ネット）

## Alternatives Considered

### Alternative 1: 融資を単独のモジュールとして分離
**メリット**: 関心の分離、独立したスケーリング
**デメリット**: 複雑化、集計パネルとの統合が困難
**判断**: 現時点では集計パネルとの統合が重要なため、main applicationに統合

### Alternative 2: 期首残高を手動入力
**メリット**: データ不正確時の対応が容易
**デメリット**: 手動運用の手間、自動化の利点を失う
**判断**: まず自動計算を実装し、手動入力は将来対応とする

### Alternative 3: 返済処理を自動化
**メリット**: 融資残高が正確に推移
**デメリット**: 実装コストが高い、返済スケジュールの管理が必要
**判断**: 初期版ではタグ付けで手動管理し、将来的に自動化を検討

## Open Questions

- [ ] 融資の更新（PATCH）で銀行やバッチ名を変更したい場合はどうするか？
  - **回答**: 変更不可とし、削除→再登録で対応（docs/wd_cc/に記載済み）
- [ ] 期首残高計算で前月データがない場合はどうするか？
  - **回答**: 0を返す（LOGIC-02に記載済み）
- [ ] 融資削除時にタグが使用中かどうかの判定基準は？
  - **回答**: TagAssignmentのcount=0の場合のみ削除（API仕様に記載済み）

すべての疑問点は`docs/wd_cc/`で解決済みです。
