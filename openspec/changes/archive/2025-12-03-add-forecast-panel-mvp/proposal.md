# Proposal: 資金繰り予測パネル MVP実装

## Why
現在のシステムは実績値の集計（AggregatePanel）に特化しており、将来の資金繰りを計画・予測する機能が存在しない。ユーザーは以下の課題を抱えている：

- **予測の非効率性**: Excelや紙で別途管理しており、実績値との整合性確認が手作業
- **計算ミスのリスク**: 手動計算による依存関係の更新漏れ
- **過去データの誤編集**: 確定した実績値を誤って変更してしまうリスク
- **操作性の悪さ**: 既存ツールはグリッド操作が不便（フィルハンドル、コピー/ペーストなし）

本提案により、実績値と同一システム内で予測値を管理でき、式による自動計算と過去期間ロックにより、効率的かつ正確な資金繰り予測が可能になる。

## What Changes
- 予測専用の ForecastPanel UI（React-Data-Grid）を新規追加し、実績期間はロック、未来期間のみ編集可能にする。
- 行・列構築ユーティリティと HyperFormula 連携層（FormulaEngine/CoordinateMapper/Adapter）を追加し、式計算とフィル/コピー/ペーストをサポート。
- 期首残高の繰越・累積ネット計算・定数行参照を含むダミーデータを内蔵し、タグ/UI周辺の不足コンポーネント（accordion/label）を補完。

## Problem
現在の `AggregatePanel` は実績値の表示専用であり、将来の資金繰りを予測するための編集可能なテーブルが存在しない。ユーザーは以下のニーズを持つ：

1. **予測値の入力**: KPI（売上、ユーザー数など）や定数（成長率、係数）を月次で入力したい
2. **自動計算**: 入力値を元に、式（例: 広告費 = 売上 × 30%）で依存関係を計算したい
3. **Excelライクな操作**: フィルハンドル（横引き）、コピー/ペースト、キーボード操作で効率的に入力したい
4. **過去期間の保護**: 実績期間は編集不可にし、未来期間のみ編集可能にしたい
5. **キャッシュ繰越**: 前月末残高を当月期首残高に自動繰越したい

## Solution
**ForecastPanel** を新規コンポーネントとして実装し、以下のMVP機能を提供する：

### MVP Scope
1. **KPI行の手入力 + 横フィル**
   - 月次セルに数値を直接入力
   - フィルハンドルで同値を右方向にコピー

2. **簡易式入力（HyperFormula）**
   - `=A1*1.1` レベルの式をサポート
   - セル参照の座標マッピング（RDG ↔ HyperFormula）

3. **定数行**
   - 成長率、割合などの係数を保持
   - 計算行から参照可能

4. **過去期間ロック**
   - 基準日（例: 2025年1月）以降のみ編集可
   - `editable` 関数で制御

5. **キャッシュ繰越**
   - 前月末残高 → 当月期首残高
   - HyperFormula式 or 自前ロジック

### Architecture
```
┌─────────────────────────────────────┐
│ UI Layer (React-Data-Grid)          │
│ - ForecastPanel.tsx                  │
│ - forecastGrid.tsx (列/行構築)      │
└─────────────────────────────────────┘
           ↓ ↑
┌─────────────────────────────────────┐
│ Domain Model Layer                   │
│ - ForecastRow (rowType, cells)       │
│ - FormulaEngine interface            │
└─────────────────────────────────────┘
           ↓ ↑
┌─────────────────────────────────────┐
│ Calculation Layer (HyperFormula)     │
│ - HFAdapter.ts (set/get/rebuild)     │
│ - 座標マッピング (RDG ↔ HF)          │
└─────────────────────────────────────┘
```

## Impact
### Benefits
- ✅ 実績値だけでなく、予測値も管理可能になる
- ✅ Excelライクな操作感で、ユーザーの学習コストが低い
- ✅ 式エンジンにより、複雑な計算を自動化
- ✅ AggregatePanel とは完全分離で、既存機能に影響なし

### Risks
1. **HyperFormulaライセンス (AGPLv3)** - 商用利用条件の確認が必要
2. **パフォーマンス** - 大量行×列（1000行×36列）での負荷テスト必要
3. **座標マッピングの複雑性** - RDG動的列 ↔ HF固定列インデックスの管理

### Mitigation
- ライセンス: Handsontable社への問い合わせ、または商用ライセンス購入
- パフォーマンス: プロトタイプでの負荷テスト、`useMemo`最適化
- 座標マッピング: 単一マップ管理、テストカバレッジ強化

## Scope
### In Scope
- ForecastPanel UI コンポーネント
- HyperFormula 統合（依存関係追加）
- 基本編集機能（手入力、フィルハンドル）
- 簡易式エンジン（`=A1*1.1`）
- 過去期間ロック
- ローカル状態管理（永続化なし）

### Out of Scope (Future)
- データベース永続化
- シナリオ機能（Base/Worst/Best）
- 高度な式（`=SUM()`, `=IF()` など）
- 列の折りたたみ/展開
- Excel形式エクスポート

## Success Metrics
- [ ] KPI行に数値を入力し、フィルハンドルで横引きできる
- [ ] 計算行に式（`=A1*1.1`）を入力し、自動計算される
- [ ] 過去期間（2024年以前）のセルは編集不可
- [ ] 前月末残高が当月期首残高に自動繰越される
- [ ] 1000行×36列のグリッドが2秒以内にレンダリングされる

## Dependencies
- `hyperformula` パッケージの追加（AGPLv3ライセンス確認済みである）
- 既存の `react-data-grid` v7.0.0-beta.52

## Timeline
- **Phase 0**: プロトタイプ作成（2-3人日）
- **Phase 1**: 基本編集とフィル（3-5人日）
- **Phase 2**: 式エンジン統合（5-7人日）
- **合計**: 10-15人日（2-3週間、開発者1名）

## References
- 検証レポート: `docs/wd_cc/verification_report_20251203.md`
- 技術調査: `docs/wd_codex/report_forecast_table_research.md`
- 要件仕様: `docs/04_prp.md`
