# Transaction Tagging UI Specification

## ADDED Requirements

### Requirement: Pending状態のタグ編集
タグ割り当てがPending状態（黄色表示）の取引レコードは、再編集可能でなければならない（SHALL）。

#### Scenario: Pending状態のタグをダブルクリックで編集
- **GIVEN** 取引レコードにタグが割り当てられているが、まだDBに反映されていない（黄色表示）
- **WHEN** 該当レコードのタグセルをダブルクリックする
- **THEN** タグ割り当てポップアップが開く
- **AND** 現在割り当てられているタグが選択状態で表示される
- **AND** タグを変更または削除できる

#### Scenario: Pending状態のタグをENTERキーで編集
- **GIVEN** Pending状態（黄色表示）の取引レコードのタグセルにフォーカスがある
- **WHEN** ENTERキーを押す
- **THEN** タグ割り当てポップアップが開く
- **AND** 現在割り当てられているタグが選択状態で表示される

### Requirement: DB登録済みタグの編集
DB登録済み（緑色表示）のタグ割り当ても、再編集可能でなければならない（SHALL）。編集すると、Pending状態に戻る。

#### Scenario: 登録済みタグをダブルクリックで編集
- **GIVEN** 取引レコードにタグが割り当てられ、DBに反映済み（緑色表示）
- **WHEN** 該当レコードのタグセルをダブルクリックする
- **THEN** タグ割り当てポップアップが開く
- **AND** 現在割り当てられているタグが選択状態で表示される

#### Scenario: 登録済みタグをENTERキーで編集
- **GIVEN** DB登録済み（緑色表示）の取引レコードのタグセルにフォーカスがある
- **WHEN** ENTERキーを押す
- **THEN** タグ割り当てポップアップが開く
- **AND** 現在割り当てられているタグが選択状態で表示される

#### Scenario: 登録済みタグを編集するとPending状態に戻る
- **GIVEN** DB登録済み（緑色表示）の取引レコードのタグを編集している
- **WHEN** タグを変更してポップアップを閉じる
- **THEN** 該当レコードの表示が緑色から黄色（Pending）に変わる
- **AND** 「内部勘定割り当て」ボタンが有効化される

### Requirement: 内部勘定割り当てボタンによるDB反映制御
タグの追加・変更は、「内部勘定割り当て」ボタンを押すまでDBに反映されてはならない（SHALL NOT）。

#### Scenario: 新規タグ割り当て時のDB反映保留
- **GIVEN** 未割り当ての取引レコードに新規タグを割り当てた
- **WHEN** タグ割り当てポップアップを閉じる
- **THEN** レコードが黄色（Pending）で表示される
- **AND** DBには反映されていない（リロードしても黄色のタグは消える）

#### Scenario: 内部勘定割り当てボタン押下でDB反映
- **GIVEN** 1つ以上の取引レコードがPending状態（黄色表示）である
- **WHEN** 「内部勘定割り当て」ボタンを押す
- **THEN** Pending状態の全てのタグ割り当てがDBに保存される
- **AND** 該当レコードの表示が黄色から緑色に変わる

#### Scenario: 編集後の内部勘定割り当てボタン押下でDB更新
- **GIVEN** DB登録済み（緑色）のタグを編集し、Pending状態（黄色）に戻った
- **WHEN** 「内部勘定割り当て」ボタンを押す
- **THEN** 編集内容がDBに反映される
- **AND** 該当レコードの表示が黄色から緑色に変わる

### Requirement: タグ割り当てポップアップのENTERキー確定
タグ割り当てポップアップ内でタグを選択後、ENTERキーを押すことで選択を確定できなければならない（SHALL）。

#### Scenario: ポップアップ内でENTERキーによるタグ確定
- **GIVEN** タグ割り当てポップアップが開いている
- **AND** タグツリー内で割り当てたいタグを選択している
- **WHEN** ENTERキーを押す
- **THEN** 選択中のタグが取引レコードに割り当てられる
- **AND** ポップアップが閉じる
- **AND** 該当レコードが黄色（Pending）で表示される

#### Scenario: タグ未選択時のENTERキー動作
- **GIVEN** タグ割り当てポップアップが開いている
- **AND** タグツリー内でタグを選択していない
- **WHEN** ENTERキーを押す
- **THEN** ポップアップが閉じる
- **AND** タグ割り当ては変更されない

#### Scenario: 複数タグ選択時のENTERキー確定
- **GIVEN** タグ割り当てポップアップが開いている
- **AND** 複数のタグを選択している（複数選択が可能な場合）
- **WHEN** ENTERキーを押す
- **THEN** 選択中の全てのタグが取引レコードに割り当てられる
- **AND** ポップアップが閉じる

### Requirement: タグ割り当てポップアップの画面中央配置
タグ割り当てポップアップは、画面中央部に固定表示されなければならない（SHALL）。

#### Scenario: ポップアップの中央表示
- **GIVEN** 取引グリッド内のタグセルを操作している
- **WHEN** タグ割り当てポップアップが開く
- **THEN** ポップアップが画面（ビューポート）の中央に表示される
- **AND** スクロール位置に関わらず、常に中央に固定される

#### Scenario: 小さい画面でのポップアップ表示
- **GIVEN** ブラウザウィンドウが小さいサイズである
- **WHEN** タグ割り当てポップアップが開く
- **THEN** ポップアップが画面の中央に表示される
- **AND** ポップアップが画面からはみ出さないように適切にサイズ調整される
- **AND** 必要に応じてポップアップ内にスクロールバーが表示される
