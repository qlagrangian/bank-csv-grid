# 要件定義：融資管理機能と集計パネル拡張

## ドキュメント概要

本ドキュメントは、`docs/03_prp.md`に記載された要求内容を、実装可能な水準まで詳細化した要件定義書です。

## 機能要件

### 機能A：銀行別期首残高の自動計算・表示

#### A-1. 期首残高の定義

**目的**: 各月・各銀行の月初残高を自動計算し、集計パネルに表示することで、資金繰り管理を支援する。

**期首残高**: 当該月の最初の時点（月初）における銀行口座残高。

#### A-2. 計算ロジック

**ケース1: 当月に取引がある場合**（LOGIC-01）
- 当該銀行・当該月の最初のトランザクション（date順で最小）を取得
- 取引種別による逆算：
  - **入金**（debit = 0）の場合: `期首残高 = balance - credit`
  - **出金**（credit = 0）の場合: `期首残高 = balance + debit`

**ケース2: 当月に取引がない場合**（LOGIC-03）
- 前月以前の最後のトランザクション（date順で最大）を取得
- その`balance`値を当月の期首残高とする（繰越）

**ケース3: 全く取引がない銀行の場合**（LOGIC-02）
- 期首残高 = 0

**前提条件**:
- CSVデータは月初から月末まで完全な取引レコードを含む
- `balance`フィールドは取引後の残高を正確に記録している

#### A-3. UI要件

**表示位置**: AggregatePanelの最上段

**表示形式**:
- 銀行ごとに1行（例: "GMO 期首残高", "SBI 期首残高"）
- 列: 既存の月次列（months配列）に対応
- スタイル: 薄黄色背景（`bg-yellow-50`）、太字（`font-semibold`）

**データ更新**:
- フィルタ（from/to日付、bank選択）変更時に自動再計算
- 他の集計データと同期して表示

#### A-4. 非機能要件

- 計算時間: 100件のTransactionに対して500ms以内
- 精度: 小数点以下を含む金額を正確に表示（丸め誤差なし）

---

### 機能B：融資管理機能

#### B-1. 融資データの登録

**目的**: 融資情報を登録し、融資残高を追跡できるようにする。

**登録項目**:
- **銀行名** (bank): BankCode型（paypay|gmo|sbi|mizuhoebiz|mizuhobizweb）
- **融資バッチ名** (batchName): 任意の文字列（例: "2024年春季融資", "運転資金A"）
- **融資額** (amount): 正の数値（単位: 円）
- **発生年月** (occurrenceYM): YYYY-MM形式の文字列（例: "2024-04"）

**バリデーション**:
- 全フィールド必須
- 融資額は正数のみ（0以下はエラー）
- 発生年月は`YYYY-MM`形式（正規表現: `/^\d{4}-\d{2}$/`）
- 同一銀行内で同じ融資バッチ名は重複不可（`@@unique([bank, batchName])`制約）

#### B-2. タグ自動生成

**目的**: 融資登録時に自動でタグを生成し、返済取引とのタグ付けを可能にする。

**生成ルール**:
1. 銀行タグの検索/作成
   - `Tag`テーブルで`name = bank`かつ`parentId = null`を検索
   - 存在しない場合は新規作成
2. 融資バッチタグの作成
   - 銀行タグの子として`name = batchName`のタグを作成
   - `parentId`に銀行タグのIDを設定
3. Loanレコードに`tagId`を保存

**重複処理**:
- 同名タグが既に存在する場合は既存タグを使用（`P2002`エラーを捕捉）

**タグ削除ポリシー**:
- 融資削除時、そのタグに`TagAssignment`が無い場合のみタグを削除
- `TagAssignment`が存在する場合はタグを保持（返済取引への紐付けを維持）

#### B-3. 融資データの更新・削除

**更新操作** (PATCH):
- 融資額の変更
- 発生年月の変更
- 融資バッチ名や銀行の変更は不可（削除→再登録で対応）

**削除操作** (DELETE):
- 融資レコードを削除
- 条件付きでタグも削除（B-2参照）

#### B-4. 融資額パネルUI

**表示形式**:
- react-data-gridによるグリッド表示
- 縦軸: 銀行名 + 融資バッチ名（階層表示ではなくフラット）
- 横軸: 年月（YYYY-MM形式）
- セル: 融資額（発生月のみ値を表示、発生月以前は "-"）

**操作**:
- 削除ボタン: 各行に配置、確認ダイアログ付き

#### B-5. 非機能要件

- 融資登録のレスポンスタイム: 1秒以内（タグ生成含む）
- 融資額パネルのグリッド描画: 20件の融資で1秒以内

---

### 機能C：集計パネルの借入残高推移・累積ネットキャッシュ表示

#### C-1. 借入残高推移行

**目的**: 融資データを集計パネルに統合し、月次の借入残高推移を可視化する。

**表示ルール**:
- 各銀行の融資バッチごとに1行
- 発生月以前のセル: 0
- 発生月以降のセル: 融資額を表示

**表示形式**:
- 行名: "銀行名 > 融資バッチ名"（例: "GMO > 2024年春季融資"）
- スタイル: 青色テキスト（`text-blue-700`）、太字（`font-semibold`）

#### C-2. 借入合計行

**目的**: 全融資の月次合計を表示する。

**計算式**:
- 各月ごとに、全借入残高推移行の合計を計算

**表示形式**:
- 行名: "借入合計"
- スタイル: 青色テキスト（`text-blue-700`）、太字（`font-semibold`）

#### C-3. 累積営業ネットキャッシュ行

**目的**: 営業活動によるキャッシュフロー（借入を除く）を可視化する。

**計算式**:
- `累積営業ネットキャッシュ = 月合計 - 借入合計`
- 各月ごとに計算

**表示形式**:
- 行名: "累積営業ネットキャッシュ"
- スタイル: 緑色テキスト（`text-green-700`）、太字（`font-bold`）

#### C-4. 表示位置

AggregatePanelの行構成（上から順に）:
1. **期首残高行群**（機能A）
2. 既存のタグ階層集計
3. **月合計行**（既存）
4. **借入残高推移行群**（機能C-1）
5. **借入合計行**（機能C-2）
6. **累積営業ネットキャッシュ行**（機能C-3）

#### C-5. 非機能要件

- report APIのレスポンスタイム: 1秒以内（Loan取得含む）
- グリッド描画: 50行×12ヶ月で1秒以内

---

### 機能D：サイドメニューUI

#### D-1. レイアウト構成

**目的**: 複数ページ間のナビゲーションを提供する。

**構成**:
```
┌─────────────┬──────────────────────────────────┐
│ Navigation  │  Content Area                    │
│ (256px)     │  (flex-1)                        │
│             │                                  │
│ ■ 取引管理  │  (現行のpage.tsx または          │
│ □ 融資管理  │   /dashboard/page.tsx)          │
│             │                                  │
└─────────────┴──────────────────────────────────┘
```

#### D-2. Navigationコンポーネント

**表示項目**:
- 取引管理: `/`
- 融資管理: `/dashboard`

**スタイル**:
- 幅: 256px（w-64）
- 背景: `bg-gray-100`
- アクティブリンク: `bg-blue-600 text-white`
- 非アクティブ: `hover:bg-gray-200`

#### D-3. ルーティング

| URL | ページ | 内容 |
|-----|--------|------|
| `/` | page.tsx | 取引Grid + タグマスター + 集計パネル |
| `/dashboard` | dashboard/page.tsx | 融資登録フォーム + 融資額パネル |

#### D-4. 非機能要件

- ページ遷移: 1秒以内
- レスポンシブ対応: 不要（デスクトップ専用）

---

## ユーザーストーリー

### US-1: 期首残高の確認

**As a** 財務担当者
**I want to** 各月の期首残高を自動で確認できる
**So that** 月次の資金繰り計画を立てやすい

**受入基準**:
- [ ] 集計パネルの最上段に期首残高行が表示される
- [ ] 各銀行・各月の期首残高が正しく計算される
- [ ] フィルタ変更時に自動で再計算される

### US-2: 融資の登録

**As a** 財務担当者
**I want to** 新規融資を登録できる
**So that** 融資残高を追跡できる

**受入基準**:
- [ ] 融資登録フォームで銀行、バッチ名、金額、年月を入力できる
- [ ] 登録時に自動でタグが生成される
- [ ] 重複する融資バッチ名はエラーになる

### US-3: 融資残高の推移確認

**As a** 財務担当者
**I want to** 集計パネルで借入残高推移を確認できる
**So that** 返済計画と営業キャッシュフローを把握できる

**受入基準**:
- [ ] 集計パネルの最下段に借入残高推移行が表示される
- [ ] 発生月以降に融資額が表示される
- [ ] 累積営業ネットキャッシュが正しく計算される

### US-4: ページ間のナビゲーション

**As a** ユーザー
**I want to** サイドメニューで取引管理と融資管理を切り替えられる
**So that** 効率的に操作できる

**受入基準**:
- [ ] サイドメニューが表示される
- [ ] 取引管理ページと融資管理ページを切り替えられる
- [ ] アクティブページがハイライトされる

---

## 制約事項

### 技術的制約

1. **データベース**: PostgreSQL（Prisma ORM使用）
2. **フロントエンド**: Next.js 15（App Router）、React、TypeScript
3. **UIコンポーネント**: react-data-grid、shadcn/ui
4. **ブラウザ**: Chrome、Edge（最新版）のみサポート

### ビジネス制約

1. **融資管理**: 当面は発生月のみ記録、返済はタグ付けで手動管理
2. **期首残高**: CSV完全性を前提（手動入力機能は将来対応）
3. **サイドメニュー**: デスクトップ専用（レスポンシブ対応なし）

### データ制約

1. **Loan**: 最大100件程度を想定
2. **Transaction**: 1万件程度を想定
3. **Tag**: 最大500件程度を想定

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-02 | 1.0 | 初版作成 |
