# 資金繰り予測テーブル 実装可能性検証レポート

**作成日**: 2025年12月3日
**対象仕様**: `docs/04_prp.md`（資金繰り予測テーブル要件）
**参照**: `docs/wd_codex/report_forecast_table_research.md`（技術調査レポート）

---

## エグゼクティブサマリー

本レポートは、`docs/04_prp.md` に記載された資金繰り予測テーブル要件の実装可能性を検証したものである。

### 主要な結論

✅ **実装可能**: 既存の技術スタック（React-Data-Grid）を活用し、HyperFormulaを追加することで要件の大部分を実現可能。

⚠️ **注意事項**:
- HyperFormulaのライセンス（AGPLv3）について商用利用条件の確認が必要
- 大量行×列のパフォーマンス検証が必要（プロトタイプでの負荷テスト推奨）
- 式入力とセル参照の座標マッピングは高難易度（綿密な設計とテストが必須）

### 推奨アプローチ

**MVP（Minimum Viable Product）からの段階的実装**:
1. Phase 1: KPI行の手入力 + 横フィル（フィルハンドル）
2. Phase 2: HyperFormula統合 + 簡易式入力（`=A1*1.1`）
3. Phase 3: 定数行 + 過去期間ロック
4. Phase 4: キャッシュ繰越 + 高度な計算式

**推定工数**: MVP（Phase 1-2）で2-3週間、Phase 3-4で追加1-2週間（開発者1名の場合）

---

## 1. 要件分析

### 1.1 対象仕様の概要（`docs/04_prp.md`）

既存の **AggregatePanel**（実績値集計）とは別に、**予測値専用のテーブル** を新規実装する。基本構造は AggregatePanel を踏襲しつつ、予測計算のための追加機能を持つ。

### 1.2 主要要件

#### 1.2.1 構造要件

**行構造**:
- デフォルト行（AggregatePanel互換）
  - 集計科目行、小計行、合計行
- 追加行（予測専用）
  - **KPI行**: 売上、ユーザー数、ARPU など主要指標
    - 入力パターン: 手入力、横引き、X%成長
  - **計算行**: 他行を参照して計算（例: 売上 × 30% = 広告費）
  - **定数行**: 係数や割合（成長率、解約率、広告費率など）

**列構造**:
- 基本列: 月次タイムバケット（`2024-01`, `2024-02`, ...）
- 追加列: メモ列、固定数値列（折りたたみ可）

#### 1.2.2 インタラクション要件（Excelライク）

- **キーボード操作**: 矢印キー、Enter/Tab によるセル移動
- **編集**: シングル/ダブルクリックでセル編集モード
- **コピー & ペースト**: 単セル/矩形範囲、Excel等との相互コピー
- **フィルハンドル**: ドラッグで横引き（同値コピー）
- **表示**: ヘッダ固定、左端科目列固定、列幅リサイズ、列順入れ替え

#### 1.2.3 計算要件

- **自動計算**: 行ごとの小計・合計、全体キャッシュ残高
- **依存関係**:
  - 行間依存: 広告費行 = 売上行 × 30%
  - 期間間依存: 前月値 → 当月値（繰越、成長率）
- **シナリオ**: Base/Worst/Best シナリオでの係数切り替え（初期実装は Pending）
- **式エンジン**: 簡易式（`base * 1.1`, `A1 * 1.1`）のサポート

#### 1.2.4 非機能要件

- **パフォーマンス**: 数百〜数千行規模でストレスなく動作
- **型安全性**: TypeScript による静的型付け
- **拡張性**: 将来のシナリオ機能や高度な式エンジンへの対応

---

## 2. 現状分析

### 2.1 既存実装の状況

#### 2.1.1 導入済みライブラリ

✅ **React-Data-Grid** v7.0.0-beta.52
- 仮想スクロール、固定列、列リサイズ、基本編集機能を提供
- `onCopy`, `onPaste`, `onFill` APIをサポート（未実装）

✅ **その他**:
- SWR（サーバー状態管理）
- Zustand（クライアント状態管理）
- Zod（バリデーション）
- Prisma（データベースORM）

❌ **HyperFormula**: 未導入（式エンジン）

#### 2.1.2 既存のPanel実装

**AggregatePanel**（`src/components/AggregatePanel.tsx`）:
- 実績値の月次集計レポート
- 階層型タグツリー（展開/折りたたみ）
- 期首残高、借入、累積ネットキャッシュ表示
- **表示専用**（編集不可）

**reportGrid.tsx**（`src/utils/reportGrid.tsx`）:
- 行・列構築ロジック
- `ReportRow` インターフェース（`id`, `name`, `depth`, `monthlyNet[]`）
- 階層列レイアウト（depth-based rendering）

**aggregateStatement.ts**（`src/utils/aggregateStatement.ts`）:
- タグごとの入出金集計
- タグレス行のパススルー処理
- 単純な合計計算のみ（依存関係なし）

#### 2.1.3 既存の編集機能（TransactionGrid）

✅ **実装済み**:
- `editOnClick: true` - クリックで即編集
- `renderEditCell` - カスタム編集セル（TagSelectEditor）
- `editable` 関数 - セル単位の編集可否制御

❌ **未実装**:
- `onCopy` / `onPaste` ハンドラ
- `onFill` ハンドラ（フィルハンドル）

### 2.2 既存の技術調査

`docs/wd_codex/report_forecast_table_research.md` にて以下が既に調査済み：

- React-Data-Grid の機能詳細（編集、コピー/ペースト、フィル）
- HyperFormula の API（式設定、依存管理、再計算）
- RDG ↔ HF の連携フロー（座標マッピング）
- AggregatePanel との比較・差分
- 統合アーキテクチャ案（MVP と将来拡張）
- リスク・懸念事項（ライセンス、パフォーマンス、座標マッピング）

---

## 3. ギャップ分析

### 3.1 HyperFormula導入の必要性

#### 要件
- 簡易式エンジン（`base * 1.1`, セル参照 `A1 * 1.1`）
- 行間依存関係（広告費 = 売上 × 30%）
- 期間間依存（前月値 × 成長率）

#### 現状
- HyperFormula未導入
- 既存の計算は単純集計のみ（`aggregateStatement.ts`）

#### 評価

| 選択肢 | メリット | デメリット | 推奨度 |
|--------|----------|------------|--------|
| **HyperFormula導入** | ✅ 式パース自動化<br>✅ 依存関係管理<br>✅ 再計算エンジン | ⚠️ ライセンス (AGPLv3)<br>⚠️ 学習コスト | **高** |
| **自前の簡易式エンジン** | ✅ ライセンス自由<br>✅ 軽量 | ❌ 開発コスト大<br>❌ バグリスク<br>❌ 保守負担 | 低 |

**推奨**: HyperFormula導入（ライセンス確認を前提に）

**ライセンス懸念の対策**:
- AGPLv3 は商用利用可能だが、ソースコード公開義務あり
- 商用ライセンスの購入を検討（Handsontable社に問い合わせ）
- または、MIT/Apache ライセンスの代替ライブラリを調査

---

### 3.2 既存AggregatePanelとの共通化可能性

#### 共通要素
- 月次タイムバケット列構造（`months[]`）
- 階層型タグツリー（depth-based rendering）
- 期首残高、借入、累積ネット表示

#### 差分要素

| 項目 | 実績Panel (AggregatePanel) | 予測Panel (ForecastPanel) |
|------|---------------------------|---------------------------|
| 編集可否 | ❌ 表示専用 | ✅ 編集可 |
| コピー/ペースト | ❌ 不要 | ✅ 必要 |
| フィルハンドル | ❌ 不要 | ✅ 必要 |
| 式計算 | ❌ 単純集計のみ | ✅ HyperFormula連携 |
| 行種別 | 実績値のみ | KPI/計算/定数行 |

#### 提案
- **共通化レイヤ**: `BaseRow` / `BaseColumn` インターフェース
- **行種別の型定義**: `rowType: 'actual' | 'kpi' | 'formula' | 'constant' | 'subtotal' | 'total'`
- **レンダラ分岐**: 行種別・列種別に応じて編集可否やスタイルを制御
- **編集ロジック**: 予測Panel専用（実績Panelには影響なし）

**実装方針**: 完全分離 + 共通インターフェース抽象化

---

### 3.3 編集可能グリッドの実装難易度

#### 既存実装状況

| 機能 | 状態 | 備考 |
|------|------|------|
| 基本編集 | ✅ 実装済み | `editOnClick`, `renderEditCell` |
| セル編集制御 | ✅ 実装済み | `editable` 関数で動的制御 |
| コピー/ペースト | ❌ 未実装 | RDG APIは存在（`onCopy`, `onPaste`） |
| フィルハンドル | ❌ 未実装 | RDG APIは存在（`onFill`） |
| 式入力 | ❌ 未実装 | HyperFormula連携が必要 |

#### 実装難易度

| 機能 | 難易度 | 工数目安（人日） | 備考 |
|------|--------|------------------|------|
| 基本編集 | 🟢 低 | 0.5 | 既存パターン流用 |
| コピー/ペースト | 🟡 中 | 2-3 | `onCopy`/`onPaste` handler追加 |
| フィルハンドル | 🟡 中 | 2-3 | `onFill` + 横引きロジック |
| 過去期間ロック | 🟢 低 | 1 | `editable` 関数で日付判定 |
| 式入力 + HF連携 | 🔴 高 | 5-7 | 座標マッピング、再計算連携 |

**合計工数（MVP）**: 約10-14人日（2-3週間、開発者1名）

---

### 3.4 パフォーマンス懸念事項

#### 要件
- 数百〜数千行規模でストレスなく動作

#### 既存調査レポートの指摘
- 大量列の初期生成負荷
- フィル/ペースト時の再計算コスト
- HyperFormula の更新バッチ処理必要

#### 対策

| 懸念 | 対策 | 優先度 |
|------|------|--------|
| 初期レンダ負荷 | `useMemo` で columns/rows 生成 | 高 |
| スクロール性能 | 仮想スクロール（RDG標準機能） | 高 |
| 再計算コスト | HF更新は一括setで実行 | 高 |
| 再レンダ頻度 | 不変データ + `rowKeyGetter` | 中 |
| 大量列管理 | 列の動的非表示（将来） | 低 |

**検証方法**: プロトタイプで1000行×24列（2年分月次）の負荷テスト

---

## 4. 実装アプローチ提案

### 4.1 MVP範囲（Minimum Viable Product）

既存調査レポート（`report_forecast_table_research.md`）と整合した最小セット：

#### Phase 1: 基本編集とフィル（工数: 3-5人日）

1. **KPI行の手入力**
   - 月次セルに数値を直接入力
   - `renderEditCell` で数値入力フィールド

2. **横フィル（フィルハンドル）**
   - `onFill` handler実装
   - 選択セルの値を右方向にコピー
   - 将来: X%成長式も対応可能に

3. **過去期間ロック**
   - 基準日（例: 2025年1月以降編集可）を設定
   - `editable` 関数で日付判定

#### Phase 2: 式エンジン統合（工数: 5-7人日）

4. **HyperFormula導入**
   - `npm install hyperformula`
   - HFAdapter クラス作成（set/get/rebuild）

5. **簡易式入力**
   - `=A1*1.1` レベルの式をサポート
   - セル参照の座標マッピング（RDG ↔ HF）
   - 式パースエラーのハンドリング

6. **定数行**
   - 成長率、割合などの係数を保持
   - 式から参照可能（例: `=A5*$B$1`）

#### Phase 3: 高度な計算（工数: 2-3人日）

7. **キャッシュ繰越**
   - 前月末残高 → 当月期首残高
   - HF式で実装: `=前月末セル + 当月入出金`

8. **行間依存**
   - 計算行の実装（広告費 = 売上 × 30%）
   - `=SUM()` などの関数サポート

### 4.2 アーキテクチャ（3層構造）

```
┌─────────────────────────────────────────────┐
│ UI Layer (React-Data-Grid)                  │
│                                             │
│ - ForecastPanel.tsx                         │
│   └─ 状態管理（rows, columns, expanded）   │
│   └─ イベントハンドラ (onFill, onPaste)    │
│                                             │
│ - forecastGrid.tsx                          │
│   └─ 列生成 (buildForecastColumns)         │
│   └─ 行生成 (flattenForecastRows)          │
└─────────────────────────────────────────────┘
                  ↓ ↑
┌─────────────────────────────────────────────┐
│ Domain Model Layer                          │
│                                             │
│ - ForecastRow                               │
│   { id, name, rowType, depth, cells[] }     │
│                                             │
│ - FormulaEngine interface                   │
│   setCellValue(addr, value)                 │
│   setCellFormula(addr, formula)             │
│   getCellValue(addr): number                │
│   onValuesUpdated(callback)                 │
└─────────────────────────────────────────────┘
                  ↓ ↑
┌─────────────────────────────────────────────┐
│ Calculation Layer (HyperFormula)            │
│                                             │
│ - HyperformulaAdapter implements            │
│   FormulaEngine                             │
│   └─ HF instance管理                        │
│   └─ 座標マッピング (RDG key ↔ HF index)   │
│   └─ 再計算イベント購読                    │
└─────────────────────────────────────────────┘
```

### 4.3 新規ファイル構成

```
src/
├── components/
│   └── ForecastPanel.tsx           # 予測Panel UI
├── utils/
│   └── forecastGrid.tsx            # 行・列構築ロジック
├── types/
│   └── forecast.ts                 # ForecastRow, RowType定義
└── lib/
    ├── formulaEngine.ts            # FormulaEngine interface
    └── hyperformulaAdapter.ts      # HF実装
```

### 4.4 依存関係追加

```bash
npm install hyperformula
```

**package.json**:
```json
{
  "dependencies": {
    "hyperformula": "^2.x.x"
  }
}
```

---

## 5. リスク評価と対策

### 5.1 高リスク

#### 1. HyperFormulaライセンス（AGPLv3）

**リスク内容**:
- AGPLv3 は商用利用可能だが、ソースコード公開義務あり
- SaaS 提供時にも公開義務が発生

**対策**:
- ✅ Handsontable社に商用ライセンスの問い合わせ
- ✅ 代替ライブラリの調査（formula.js, ExcelJS など）
- ✅ 最悪の場合、簡易式エンジンを自前実装（MVP範囲に限定）

**影響度**: 🔴 高
**発生確率**: 🟡 中
**優先度**: **最優先で確認**

---

#### 2. 大量行×列のパフォーマンス

**リスク内容**:
- 1000行 × 36列（3年分月次）で初期レンダやフィル操作が遅延
- HyperFormula の再計算コストが高い

**対策**:
- ✅ プロトタイプで負荷テスト（1000行×36列）
- ✅ `useMemo` で columns/rows 生成の最適化
- ✅ HF更新は一括 batch 処理
- ✅ 仮想スクロール（RDG標準）の活用
- ✅ 不変データ構造 + `rowKeyGetter` で再レンダ抑制

**影響度**: 🔴 高
**発生確率**: 🟡 中
**優先度**: **Phase 1完了後に検証**

---

### 5.2 中リスク

#### 3. 座標マッピングの複雑性

**リスク内容**:
- RDGの動的列キー（`m_0`, `m_1`, ...） ↔ HFの固定列インデックス（0, 1, ...）
- 列の追加/削除/並び替え時にマッピングがズレる

**対策**:
- ✅ 単一の座標マップを状態管理（`columnKeyToHFIndex`）
- ✅ 列変更時にマップを再構築
- ✅ テストカバレッジ強化（座標変換のユニットテスト）

**影響度**: 🟡 中
**発生確率**: 🟡 中
**優先度**: Phase 2（式エンジン統合時）

---

#### 4. 式エラーのUX

**リスク内容**:
- 循環参照、式パースエラー、`#REF!` エラーなどの扱い
- ユーザーにエラー内容をどう伝えるか

**対策**:
- ✅ エラーセルのハイライト表示（赤背景など）
- ✅ ツールチップでエラー詳細を表示
- ✅ 式検証UIの実装（入力時にリアルタイム検証）

**影響度**: 🟡 中
**発生確率**: 🟢 低（MVP範囲では単純式のみ）
**優先度**: Phase 2（式エンジン統合時）

---

### 5.3 低リスク

#### 5. 既存AggregatePanelへの影響

**リスク内容**:
- 予測Panel実装が既存の実績Panelに影響を与える可能性

**対策**:
- ✅ 完全分離（新規ファイル、新規コンポーネント）
- ✅ 共通コードは抽象化レイヤで管理
- ✅ 既存のテストが壊れないことを確認

**影響度**: 🟢 低
**発生確率**: 🟢 低
**優先度**: 低（設計段階で考慮済み）

---

## 6. 推奨事項

### 6.1 ユーザー確認事項

以下の点についてユーザー（プロダクトオーナー、ステークホルダー）に確認が必要：

1. **HyperFormula導入の承認**
   - ライセンス（AGPLv3）の商用利用条件を確認
   - 商用ライセンス購入の予算確保
   - または、自前の簡易式エンジン実装を選択

2. **MVP範囲の妥当性**
   - Phase 1-2（KPI手入力、横フィル、簡易式）で十分か
   - Phase 3（高度な計算）の優先度

3. **実装優先度**
   - すぐに着手するか、段階的に進めるか
   - 他の機能開発との優先順位

### 6.2 技術的確認（実装前）

1. **HyperFormulaのプロトタイプ作成**
   - 小規模グリッド（10行×12列）で動作確認
   - 座標マッピングの検証
   - 再計算イベントの購読テスト

2. **パフォーマンステスト**
   - 1000行×36列での負荷テスト
   - フィル操作、ペースト操作の速度測定
   - 最適化ポイントの特定

3. **ライセンス調査**
   - AGPLv3 の商用利用条件の再確認
   - Handsontable社への問い合わせ
   - 代替ライブラリのリサーチ

### 6.3 実装ロードマップ

| Phase | 内容 | 工数 | 成果物 |
|-------|------|------|--------|
| **Phase 0** | プロトタイプ作成 | 2-3人日 | HF動作確認、パフォーマンステスト |
| **Phase 1** | 基本編集とフィル | 3-5人日 | KPI手入力、横フィル、過去期間ロック |
| **Phase 2** | 式エンジン統合 | 5-7人日 | 簡易式入力、定数行、座標マッピング |
| **Phase 3** | 高度な計算 | 2-3人日 | キャッシュ繰越、行間依存 |
| **Phase 4** | UI改善・最適化 | 3-5人日 | エラー表示、パフォーマンス最適化 |

**合計**: 15-23人日（3-5週間、開発者1名の場合）

---

## 7. 結論

### 7.1 実装可能性の総合評価

✅ **実装可能**: 既存の技術スタック（React-Data-Grid）を活用し、HyperFormulaを追加することで、`docs/04_prp.md` に記載された要件の **大部分を実現可能**。

### 7.2 クリティカルパス

1. **HyperFormulaライセンスの確認** → 商用利用が可能か、商用ライセンス購入が必要か
2. **プロトタイプでのパフォーマンス検証** → 大量行×列での動作確認

この2点をクリアできれば、実装は **技術的に問題なく進行可能**。

### 7.3 次のアクション

- [ ] HyperFormula商用ライセンスの問い合わせ
- [ ] プロトタイプ作成（Phase 0）
- [ ] パフォーマンステスト
- [ ] ユーザーへのMVP範囲の確認
- [ ] 実装優先度の決定

---

**以上**
