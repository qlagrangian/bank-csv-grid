前回までのSessionは、docs/01_prp.mdをもとにProposalが生成された。すなわち、CSVを抽出してきて所望のフォーマットにまとめるところまでである。

ここからは、前回のdocs/01_prp.mdの後半部にも書いたが、「紐付け実行」から先の部分を実装してしまいたいと考えている。
すなわち、<総合振込明細>にせよ、<カード利用明細>にせよ、表形式の抽出の前後の動線である。

すなわち、そもそも、この機能というのは、bank-csv-grid/src において、CSVからインポートした明細の表形式DataGrid画面から、ある特定の明細を選択して、このPDF抽出処理をその特定の明細に当てることが目的だ。
どういうことかというと、インポートしてきた銀行明細には、もちろん個別の銀行振込トランサクションもあるが、中には、総合振込やカード利用料の引落などのレコードが存在しているのだ。
この場合、何が問題かといえば、それは、総合振込に含まれる個別の振込先と金額の情報や、カード利用料に含まれる個別の決済内容など、個別具体的な明細はわからないということなのだ。
従って、インポートしてきた銀行明細の中に、「総合振込」や「カード引落」などのレコードがあった場合は、PDFの明細を紐付けて、その詳細がどういう明細なのかを示す必要があるのである。
いずれ、どの明細であろうとも、このPDF→CSV抽出画面へ遷移できるようにボタンを配置しておきたい。このボタンは、現在の「タグ割り当て」の右隣に列を新設し、「PDF明細割当」というボタンを設ける。
このボタンを押すと、その明細に紐づけるべきPDFの明細CSV抽出画面に遷移するわけである。「PDF明細割当」ボタンは全ての明細に配置することとしよう。


まず、ここまでのまとめとして、変更Proposalは、bank-csv-grid/src 側での開発と、pdf-import-standalone側での開発との二軸が必要であるということだ。

さて、この時、TransactionGrid側で「PDF明細割当」ボタンを押すと、pdf-import画面に遷移し、所望の操作の後、CSVを抽出できる。ここからが問題である。

⓪TransactionGrid側で「PDF明細割当」ボタンを押すと、そのレコードのインポート時にすでに持っている「ID、銀行、取引日」という情報だけは、pdf-import-standalone側に渡されなければならないということ。かつ、渡された「ID、銀行、取引日」は、pdf-import-standalone側では、抽出されてきたCSV明細の「取引日、銀行」部には自動的に、この内容がセットされなければならず、抽出されたCSV明細のIDは、bank-csv-grid/src側から渡された「ID」に「-XXX」形式で通し番号が接尾辞として付与されてアサインされなければならない。この処理はマストである。つまり、一個目の抽出明細は`UUID-001`という形式である。
①また、pdf-import-standalone側で抽出ないし定義された、「ID、取引日、内容、入金、出金、残高、メモ、銀行」の内容が、「紐付け実行」を押されると、bank-csv-grid/src 側に転送されなければならないということである。※pdf-import-standalone側では、ID列も用意しておかなければならない。
②「紐付け実行」により、bank-csv-grid/src 側に「ID、取引日、内容、入金、出金、残高、メモ、銀行」の内容が、転送されると、bank-csv-grid/src 側で何が起こるかというと、元々の「PDF明細割当」ボタンを押された銀行明細レコードはDeactivate化（＝Tag付できなくなる）とし、その代わりに、そのレコードがあった場所に、この転送されてきた明細一式が挿入されるのである。色は薄い青とする。

※転送されてきたレコードが表示されている場合、Deactivate化されている明細の「PDF明細割当」ボタンだけはActiveでありサイド割り当てすることができる。しかし、これをやると、INSERTされた（転送されてきた）明細はリセット削除され、PDF側で新たにやった場合に、その内容が反映されるものとする。この処理は、UUID-XXXに対する正規表現などで対応すれば良い。
※INSERTされた（転送されてきた）明細に対してもさらに「PDF明細割当」ボタンを押すことは許容する。この場合、同じ処理フロートするが、IDが、さらに通し番号が付加されるので、`UUID-XXX-YYY`という形式にならねばならない。

ここまでの実装Proposalを書いてほしい。かなり、複雑かつ正確性が求められるので、絶対にミスしないように、実際のCodeBase／Factに忠実に、計画をたて、常にERRORしないかに気を払いながら、Proposalを書くこと。