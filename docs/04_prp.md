# 資金繰り予測テーブル要件（React-Data-Grid + HyperFormula 前提）

## 0. 目的・前提

- 既存の **AggregatePanel** は「実績値」の集計表である。
- 本テーブルは **予測値専用** のテーブルとして新規実装する。
- 行・列のキー構造（集計科目・月次バケットなど）は、基本的に AggregatePanel と同一とする。
- ただし、予測計算のために **AggregatePanel には存在しない追加の行・列** を持つことを許容する。
- UI レイヤには React-Data-Grid（以下 RDG）、数式・依存関係の計算には HyperFormula（以下 HF）を利用することを想定する。

これらの機能は別Panelで用意する。
---

## 1. 構造要件

### 1.1 行構造

#### 1.1.1 デフォルト行（AggregatePanel 互換）

- 集計科目行
  - 既存 AggregatePanel の「実績値」行と同じキー構造・科目マスタを利用。
- 小計行 / 合計行
  - カテゴリごとの小計行
  - 全体合計行
  - 既存 AggregatePanel の「行スタック」をデフォルト構成として採用する。

#### 1.1.2 追加行（予測専用）

AggregatePanel の行設定を基準として、以下のような「予測計算用行種別」を追加できるようにする。

- KPI 行
  - 用途:
    - 予測計算のベースとなる主要指標（売上、ユーザー数、ARPU など）を保持する。
  - 入力・計算パターン（例）:
    - 単純入力:
      - 各月の値を手入力する。
    - 先頭数値の横引き:
      - ある月の値を基準として、右方向の月に同一値をコピーする。
    - 先頭数値の X% 成長:
      - 基準月の値を起点に、以降の月を X% 成長させて自動計算する。
      - X は別セル（定数行など）で管理してもよい。

- 計算行
  - 用途:
    - KPI 行など他の行を参照して、各月の計算値を表示する。
    - Excel でいう「計算式を横方向にコピーした状態」に相当。
  - 特徴:
    - HF を利用して「別行・別セル参照」の数式を持つ。
    - 例: 売上高行 × 30% = 広告費行、など。

- 定数行
  - 用途:
    - KPI 行で利用する係数や割合などの「定数」を月ごとに保持する。
    - 例: 成長率 X%、解約率 Y%、広告費率 Z% など。
  - 特徴:
    - 原則手入力だが、必要であれば式を持つことも許容。

> 補足:
> - 将来的な拡張を見据え、行には `rowType`（e.g. `actual`, `kpi`, `formula`, `constant`, `subtotal`, `total` など）を持たせる設計を想定する。
> - 追加行は、対象の集計科目ツリーの中に挿入する場合と、専用の「KPI セクション」を別枠で持つ場合の両方を許容する。

---

### 1.2 列構造

- 基本列:
  - **月次のタイムバケット列**
    - 既存 AggregatePanel と同じ「列スタック」を採用する。
    - 例: `2024-01`, `2024-02`, ..., `2025-12` といった連続月。
- 追加列（予測用補助列）:
  - 先頭付近に、以下のような「非年月日カラム」を持つ可能性を許容する。
    - メモ列:
      - 行単位の備考・メモを保持するための列。
    - 固定数値列:
      - 行全体に効く固定パラメータ（例: ベースとなる単価、係数）を格納する列。
  - これらの列は、必要に応じて「折りたたみ / 展開」ができると望ましい。

---

## 2. インタラクション要件（Excel ライク）

### 2.1 キーボード操作

- 矢印キーによるセル移動（上下左右）
- Enter / Tab によるセル移動
  - Enter: 縦方向（次の行）へ移動（行末の挙動は別途定義）
  - Tab: 横方向（次の列）へ移動（行末・最終列での挙動は別途定義）
- 編集モード:
  - シングルクリックまたはダブルクリックでセル編集モードへ入る（Excel での F2 相当）。

### 2.2 編集

- 金額セルの直接編集
  - 数値入力のみ許容（必要に応じてバリデーション）。
- 数値フォーマット:
  - カンマ区切り（千単位区切り）
  - マイナス値は赤字表示
  - 表示フォーマットは固定とし、ユーザーがフォーマットそのものを変更する UI は提供しない。
- ドロップダウン:
  - 今回はカテゴリ選択などのドロップダウンは実装しない。

### 2.3 コピー & ペースト

- 単セルコピー & ペースト
  - ブラウザ標準のクリップボード経由で、Excel 等との相互コピーを可能な範囲で対応する。
- フィルハンドル（ドラッグコピー）
  - 同じ行 / 列に対して、選択セルの値をドラッグでコピーできる。
  - 先頭セルの値を横方向に引っ張ることで「横引き」ができること。

### 2.4 表示まわり

- ヘッダ行固定
  - スクロールしても列ヘッダは常に表示される。
- 左端の科目列固定
  - 科目名・カテゴリなどの左側カラムを固定し、右側の月次列のみ横スクロールする。
- 列幅リサイズ
  - 列境界をドラッグして幅を変更できる。
- 列順入れ替え
  - ドラッグ & ドロップで列順を変更できる（必要であれば無効化も検討）。

### 2.5 視覚的要件

- マイナス値のハイライト
  - マイナス値は赤字、もしくは背景色で強調表示する。
- 未来期間のみ編集可
  - 過去の実績期間は「ロック」し、編集不可とする。
  - 未来期間の開始境界（○年○月以降）の定義は外部設定またはロジックで決定。
- 小計行・合計行のスタイル差別化
  - 太字、背景色、罫線などで、通常行と視覚的に区別する。

---

## 3. 計算要件（予測ロジック）

### 3.1 自動計算

- 各行の期間ごとの入出金から、行ごとの小計・合計を自動計算する。
- 全体のキャッシュ残高を自動計算する。
  - 計算例:
    - 期首残高 + Σ（当期の入金行） − Σ（当期の出金行） = 当期末残高
  - 月ごとに「前月末残高 → 当月期首残高」として繰り越す。

### 3.2 依存関係

- 行間の依存:
  - 一部行は別行の比率計算を行う。
    - 例: 広告費行 = 売上行 × 30%。
  - 一部行は、別の固定 Cell 参照による計算を行う。
    - 例: 前期数値の 1.03 倍成長（`前期セル × 1.03`）。
- 期間間の依存:
  - 月ごとのキャッシュ残高は、前月からの繰越を考慮する。
  - 成長率などの計算も「前月値 → 当月値」という時系列依存を持つ。

### 3.3 シナリオ

- シナリオ別の係数（成長率、解約率など）で一括再計算を行えるようにする構想を持つ。
  - 例: Base / Worst / Best シナリオで係数が異なる。
- ただし、シナリオ機能は複雑化を招くため、初期実装では **Pending（後回し）** とし、設計上考慮するに留める。

### 3.4 式エンジン（将来）

- 最小限の簡易「式エンジン」を持つ。
  - 完全な Excel 互換までは目指さない。
  - 例: `base * 1.1` 程度の式、簡単なセル参照（`A1 * 1.1`）が書ける。
- HF を利用する場合は、A1 形式のセル参照と基本関数（`SUM` など）をサポート範囲として検討する。

---

## 4. 非機能要件

- パフォーマンス:
  - 数百〜数千行規模でもストレスなく操作できること。
  - スクロール、編集、再計算などの操作で UI がもたつかないこと。
- アーキテクチャ:
  - SSR / SPA いずれの構成でも利用可能な実装にする。
- 型安全性:
  - TypeScript による静的型付けを前提とし、行・列定義、計算ロジックを型安全に扱う。
- 拡張性:
  - 将来的なシナリオ機能や高度な式エンジンへの拡張に対応できるよう、行種別・列種別などのメタ情報を持つモデル設計とする。


**Think in English, but interface with User in Japanese. Think hard and output excellent report. Do it.**