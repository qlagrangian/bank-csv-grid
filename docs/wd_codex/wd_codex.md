# 次期開発要件ブラッシュアップ（docs/03_prp.mdの整理版）

本ドキュメントは docs/03_prp.md のラフ要望を、現行コード/仕様（openspec/AGENTS.md, openspec/project.md, src 以下の実装）と整合する形に再構成したもの。設計・実装計画の起点として利用する。

## 現状前提（抜粋）
- 銀行コード: `paypay`, `gmo`, `sbi`, `mizuhoebiz`, `mizuhobizweb`。取引は `TransactionRow` で `id/bank/date/credit/debit/balance/memo/tag/isRegistered` を保持。タグは `TagAssignment` が正。
- AggregatePanel: `/api/report` から月次ツリーを取得し、react-data-grid で表示（上にフィルタ、下に月合計行）。タグツリーは別途 `TagMasterEditor` で管理。
- PDF紐付け済み: 取引行→pdf-importを開き、抽出結果を子行として登録（親Deactivate/子行連番）。
- タグCSV: Level列シフト形式（UTF-8, header必須, 深さ6, 空セル継承, Level1未定義はエラー）。replace時は TagAssignment→Tag を削除後に再構築。

## 要件整理

### A. 集計パネルに「銀行別期首残高」行を追加
- UI: AggregatePanel の最上段に薄黄色の行を追加。列は既存の months 列（全銀行対象）。
- ロジック（銀行×月のセル計算）:
  1) 対象月に該当銀行の取引がある場合、当該銀行・当該月の「最初の取引」を取得し、  
     - 入金行（debit=0）のとき: `balance - credit` を期首残高とみなす  
     - 出金行（credit=0）のとき: `balance + debit` を期首残高とみなす
  2) 対象月に取引がないが、前月以前に取引がある場合: 最も新しい取引の `balance` を対象月の期首残高とする（繰越）。
  3) 当該銀行の取引が1件もない場合: その銀行の全月セルは0。
- データ取得: `/api/report` とは別計算でもよいが、同一API応答に組み込む形が望ましい（追加フィールド例 `openingBalances[bank][monthIndex]`）。UIは1行目に固定表示。

### B. 新規借入残高登録と融資額パネル（ダッシュボード新設）
- 新ページ（ダッシュボード）を追加し、現行ページから遷移・戻りを可能にする（共通レイアウトを流用可）。
- 登録機能（フォーム）:
  - 項目: 銀行名 / 融資バッチ（同一銀行で複数借入を識別するラベル。タグの子科目と連動する前提） / 融資額 / 発生年月。
  - 保存先: 新テーブル（Loan?）を追加する想定。bank, batch, amount, startMonth を保持。
  - UI: 登録→一覧再描画。バリデーション: 金額数値/年月必須、同一 bank+batch+startMonth 重複はエラーまたは上書き。
- 融資額パネル（確認用）:
  - 表示: 縦軸=銀行>融資バッチ（階層）、横軸=年月、セル=融資額（発生月のみ値、以降は残高推移をどう持たせるかは後述）。AggregatePanel類似のグリッドでよい。
  - データ取得: `/api/loans` 的な新APIで一覧を返却（バッチ階層化 + 月列マッピング）。

### C. 集計パネルに借入残高推移と累積営業ネットキャッシュを追加（最下段）
- 追加行（下段）:
  1) 各銀行の借入残高推移行（銀行>バッチを横並び、発生月以降に融資額を置く。発生月以前は0フィル）。  
  2) 借入合計行（上記の月次合計）。  
  3) 累積営業ネットキャッシュ行 = 既存の合計行（月次ネット合計）− 借入合計。
- 表示位置: AggregatePanel の月合計行の下に追加するか、月合計行を含めたフッターセクションとして並べる。
- データ連携: Bで登録した融資データを `/api/report` 応答に統合するか、フロントで別APIの結果をマージする。月単位の配列に射影する処理が必要（発生月以降を横展開）。

## 追加で必要なデータモデル/ API（案）
- `Loan` テーブル（新規）: id, bank, batch (string), amount (number), startMonth (YYYY-MM-01など), createdAt/updatedAt。
- API:
  - `POST /api/loans`（作成）, `GET /api/loans`（一覧, bank/batchフィルタ可）。
  - `/api/report` 拡張: `openingBalances` と `loanMonthly`（銀行・バッチ別の月次配列、合計、ネットキャッシュ）を付与するか、別エンドポイントで渡す。

## 実装上の留意点
- 期首残高算出はトランザクションデータに依存するため、report API 内で計算するのが整合性高い。既存reportの月配列と同一インデックスを用いる。
- 融資データの月配列化は「発生月のみ値、以降は同額を持ち回る/しない」の定義が未確定。現要望は「横置きで値を置く（推移は一旦固定）」だが、将来「残高推移（返済控除）」に拡張しやすい設計にする。
- Tag連動（bank>batchをタグ子科目とする）を求めるなら、Loan保存時にタグ存在チェック/作成との整合を検討（本ドキュメントではタグ作成までは規定しない）。
- UI配置: ダッシュボード新設（ルーティング追加）が必要。現行の `/` は取引/タグ/集計ページのまま。

## オープンな前提・確認事項
- 期首残高ロジックの信用: 「最初の取引の前残高」を balance±(credit/debit) で推定してよいか（残高が実測値でない場合の補正は不要か）。
- 融資バッチのタグ連動要否: Loan登録時にタグも生成するか、単独管理か。
- 借入残高推移の定義: 発生月以降に定額を置くだけでよいか。返済や残高更新は当面扱わない方針で良いか。
- ダッシュボードのレイアウト/ナビゲーション: どのURLに配置し、戻り動線をどうするか。

### オープン事項への回答・指針（磨き直し）
- 期首残高ロジック  
  - CSVは当月1日〜月末で区切られる前提。最初の取引を基準に「取引前残高」を推定してよい。  
  - 入金行なら `balance - credit`、出金行なら `balance + debit` を期首残高とする。補正は不要。
- 融資バッチとタグ  
  - 融資登録時に銀行直下に「融資バッチ」タグも自動生成する方針が望ましい。  
  - 目的: 返済取引にそのタグを付けることで、将来、借入残高推移の計算（返済差引）に使える。
- 借入残高推移の定義  
  - まずは発生月に借入額を横展開するだけでよい。当面は返済を考慮しない。  
  - 将来は、返済取引に付与されたバッチタグを利用して残高更新ロジックに拡張する。
- ダッシュボードのレイアウト/導線  
  - URL/戻り導線は使いやすさ優先で設計。  
  - SaaS的な右サイドメニューで「借入登録」「融資パネル」「集計」などを切り替える構成を想定。既存トップページからの遷移・復帰を用意する。

## 次に取るべきステップ（提案）
1) 上記オープン事項の確認（特に借入残高の推移定義とタグ連動の有無）。  
2) 新しい change-id を切って Proposal/Tasks/Spec delta を作成。capabilities: `reporting`（新設または既存拡張）, `loans`（新設）, `pdf-import` は影響なし。  
3) 設計: `/api/report` 拡張 vs 別エンドポイント分離、Loanデータモデル、フロントのダッシュボード構成。  
4) 実装フェーズ: a) Loan CRUD + パネル、b) opening balance 行追加、c) 借入行＋累積ネットキャッシュ追加、d) テスト/検証。
