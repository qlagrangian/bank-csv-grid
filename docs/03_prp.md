
# <001>集計パネルコンポーネント改良[A]
    - 銀行期首残高表示
        - 現状はTransaction Gridの集計結果を表示する機能とUIとなって居る。
        - ここに、計算ロジックは全く別のものを新設して良いが、UI上は、集計部の上の最上段に「各銀行の、各月の月初の残高」を表示する薄黄色の行を設けたい
        - つまり、Rowはすべて、システムで登録されている銀行が網羅されており、次のような処理が走った結果が表示される；
            - <001-LOGIC-01>すなわち、TransactionGridにある明細レコードにおいて、各月の、各銀行の、一番最初のレコードを検出してきて、これに対し、
                - そのレコードが「入金」（つまり出金カラム＝０）なら、そのレコードにおいて「残高ー入金」した数値
                - そのレコードが「出金」（つまり入金カラム＝０）なら、そのレコードにおいて「残高＋出金」した数値
            -　このいずれかを、最上段の、該当する銀行の該当する月のセルにアサインして表示する
            - これを自動的に、集計パネルコンポーネントに表示させたい
        - この機能は、tag付されていても、されていなくても、TransactionGridにデータが存在する以上は必ず自動で走るものとする
        - <001-LOGIC-02>TransactionGridにその銀行のすべてのデータがない場合のみすべての月で０とする
        - <001-LOGIC-03> ただし、[当月のデータがなくい場合]でも前月以前のデータが存在する場合は、当該の銀行の存在する、**一番最後（つまり最も日付が新しいもの）**のレコードの「残高」の数値を「当月の期首残高」としてアサインするものとする。前月以前の一番最後の残高を拾えば良いということである。もし、当月のレコードが一つでも存在する場合は<001-LOGIC-01>に従えば良い。
    - このような都合を鑑み、裏の残高拾い上げ計算ロジックは、集計ロジックとは別に用意しつつ、UI上は、最上段に薄黄色着色で用意し紐づければ良い    

# <002>新規借入残高登録機能と融資額パネル
    - ダッシュボードページを新設（現行UIから遷移＆現行UIに戻るが可能）し、このダッシュボードページに作成
        - 新規借入残高登録機能
        - 融資額パネル（現状確認用）
    - 新規借入残高登録機能
        - 登録するもの：
            - 銀行名
            - <銀行名の子科目タグとして>銀行ごとの融資バッチ（※同じ銀行から複数借入の場合があり）
            - 融資額
            - 発生年月
    - 融資額パネル
        - 登録パネルで登録した結果が、融資額パネルでは、連想配列ライクに、縦軸キーに「銀行名」>「融資バッチ」が配列されており、横軸に「発生年月日」、セルに「融資額」の登録状況を整理できるようにする。
        - この配列は、集計パネルライクでOKであり、AggregatePanelライクでOK
    - ただし、本丸の集計パネルAggregatePanelに次項で新設する新機能[B]から、この「融資額パネル」の数値を参照する機能が発生する。その前提で設計実装を行うこと。

# <003>集計パネルコンポーネント改良[002]
    - 集計パネルコンポーネントの改良はすでに述べたとおりである。
    - この集計パネルコンポーネントの"最下段"に結論だけて言えば、次のような機能を加えたい。
        1. 上記<002>にて定義した、融資残高の各銀行ごとの推移とその借入残高合計を表示する機能
            - <002>では、銀行名>融資バッチごとに、発生年月と融資額を決めたが、この内容が、<003>-1.として、AggregatePanelの各年月日ごとに、発生月以降横置き表示になるように配置（注１）
            - そのRowの発生月以前のColumnは0-fill
            - 各月毎にこれらの借入金合計が計算されること
        2. さらにこれら<003>-1.に示した「各銀行借入残高推移」「借入合計」の表記の一番下の段に【累積営業ネットキャッシュ】という行を配置したい。
            - これは、各月毎に、AggregatePanelの「合計」数値から「借入合計」を差し引いた数値を記入するものとする。

    ※注１＝借入残高推移とは書いたが、今は開発の都合上、一旦、横置きで構わない・

ここまでの内容の実装計画を立てたいと思っている。現状のUI構成は下記`[参考] bank-csv-grid/src によるUI構成の概略`を参考とすること。

```[参考] bank-csv-grid/src によるUI構成の概略：
UIコンポーネント棚卸（src/components、src/app/page.tsxでの構成）

  - FileImporter.tsx: 銀行選択＋CSVアップロード（PapaParseでShift_JIS読み取り想定）、取込完了でコールバック。
  - ExportModal.tsx: 取引データのエクスポートUI。
  - BankSelect.tsx: 銀行コード選択用の共通ドロップダウン。
  - TransactionGrid.tsx: react-data-gridで取引一覧を表示・編集。
      - タグセルはダブルクリック/Enterで TagSelectEditor を開き、Deactivate行以外は編集可。
      - PDF明細割当 ボタン列があり、親ID/銀行/取引日をクエリに付けて pdf-import 画面を新規タブで開く。
      - 行スタイル: Deactivate行（親行）/リンク子行で色分け。
  - TagSelectEditor.tsx: タグ割当ポップアップ。ツリーから選択／検索／未割当クリア。TagAssignmentはグリッド一括反映でDB登録。
  - TagMasterEditor.tsx: タグツリーの閲覧・子追加・削除。右側にCSVインポート/エクスポートUIあり。
      - CSV: POST /api/tags/import-csv（mode=merge|replace, dryRun選択）、GET /api/tags/export-csv。継承型Level列フォーマットに対応。
  - AggregatePanel.tsx: フィルタ（from/to/bank）付きの集計レポート表示。/api/reportを呼び、階層ツリー＋月次列をreact-data-gridで描画。全展開/折りたたみ操作あり。
  - ProgressBar.tsx: シンプルなプログレス表示（使用箇所は限定的）。

  ページ構成（src/app/page.tsx）

  - 上部: FileImporter（インポート）＋ ExportModal。
  - タグマスター: TagMasterEditor を動的ロード。
  - 編集モードトグル: 登録済みも編集する/しない。
  - グリッド: TransactionGrid にローカル行を渡し、タグ編集やPDF紐付けを提供。
  - 一括反映ボタン: 新規行は /api/transactions/bulk-register、タグ変更は /api/transactions/[id]/tags へ。
  - 下部: 集計パネル AggregatePanel。

  関連API（UI側で使用）

  - タグ: /api/tags CRUD、/api/tags/import-csv、/api/tags/export-csv
  - 取引: /api/transactions, /api/transactions/bulk-register, /api/transactions/[id]/tags
  - PDF紐付け: /api/transactions/link-pdf（親IDの子行を置換挿入）
  - レポート: /api/report
```

```[検討のための思考フロー]
1. この機能を、この対象を構築する際必要となるであろう理想ロジックを描く
2. その際、その実装にかかって必要と思われる、Codeとその箇所を特定する
3. 特定するのみでは、不十分で、このように変更すれば良いだろうという想定を立て、その副作用も抑えながら作戦を練る
4. その作戦が明快に実装可能か、上記要求を十分実現可能か、について一から流れを追って検証し、問題が無さそうであれば、実装手順として落とす。
　　※実装手順は、最短最速かつ、単純明快にブレークダウンされて居ること
```

** 後続の検討依頼に対応するために、本PJのCode解析・実装設計の検討を行う際は、[検討のための思考フロー]に従うこと。**
** 特に、本Documentは人間が書き下した、抜け漏れのある内容であるから、検討に際して、Code／Logicに不備がないように、この仕様Docの内容も補完して思考すること。**

** Think in English, interface in Japanese. **